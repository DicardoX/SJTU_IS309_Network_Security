# 网络安全技术 Lecture 9 区块链和比特币

## 1. 区块链 *Blockchain*

### 1.1 区块链的本质和特点

- **本质**：区块链是一种通过**密码哈希函数连接**，通过**分布式数据库存储数据**，基于**去中心化或多中心的分布式共识协议添加数据**的**仅添加的数据库**，是**分布式账本 *Distributed Ledger*** 的一种。
- **特点**：**提供不依赖于第三方机构的可信数据**
    - 不可伪造、防篡改、不可否认、可追溯，没有人可以恶意操纵数据



- **区块链**是一种基于**密码学技术**以**分散或多中心**方式**存储和管理数据的数据库**。**区块链系统 *Blockchain System*** 是一套**基于密码学技术的协议**，**以去中心化或多中心的方式存储和管理数据库**，**系统数据库是一个（哈希）区块链**。

    - 提供了一个分布式信任机制 *Distributed Trust Mechanism*，不需要信任任何机构
    - **“可信数据”**的特点：**不可伪造 *unforgeable***、**防篡改 *tamper-resistant***、**不可否认 *undeniable/non-repudiation***、**可追溯 *traceable***，**不可被恶意操纵**
    - 可以被用来支持那些需要依靠可信任第三方机构 (*CA*) 的应用，结合**智能合约**，降低成本，提高业务效率

- 构成：**区块链的数据结构**

    - **记录 *Records***：交易 *Transactions*、合约 *Contracts*、事件 *Events*

    - **块 *Blocks***：每个块都是**一组有序的记录**，**每个块代表一个对数据库的写操作**

    - **区块链 *Blockchain***：**一个仅可添加的数据库**，根据块添加的顺序，使用**加密哈希函数**来连接块

        - 修改或删除任何块或记录都会破坏之后连接的块，会被检测到

        <img src="./cut/截屏2021-06-15 下午2.45.27.png" alt="avatar" style="zoom:40%;" />

        - **数据存储形式：哈希区块链**
        - 可以将哪些数据/块添加到现有的区块链？
            - 由**分布式共识协议 *Distributed Consensus Protocols*** 决定，**分布式数据库**是一个必要条件，不需要依赖任何可信任机构

        - 每个用户在其**本地数据库**中以**哈希区块链**的形式**存储数据的副本**
        - 用户通过**分布式共识协议**协作确定可以将哪些（新）数据/块附加到当前区块链

-------

### 1.2 区块链相关技术

- 相关技术：智能合约 *Smart Contracts*、密码学 *Cryptography*、分布式数据库 *Distributed Database*、*P2P* 网络 *P2P Network*、博弈论 *Game Theory*、共识 *Consensus*

- 分布式数据库和分布式账本的区别：
    - 分布式数据库：**信任边界 *Trust Boundary*** 包含了所有该数据库的节点，这些**节点必须互相信任**
    - 分布式账本：改变了信任边界，**允许节点显著减少他们对他人的信任程度**
        - 不要不加选择地发送数据，验证接收到的一切数据，并不完全相信其他节点

<img src="./cut/截屏2021-06-15 下午3.15.06.png" alt="avatar" style="zoom:50%;" />

- 区块链的技术框架：

    - 应用层：应用、智能合约
    - **核心层**：**分布式共识协议**、**密码学**
        - 密码学：安全性、隐私保护；不可否认性（签名）；防篡改
        - 分布式共识协议：防篡改；一致性；去中心化的信任

    <img src="./cut/截屏2021-06-15 下午3.20.34.png" alt="avatar" style="zoom:30%;" />

    - 数据层：分布式数据库
    - 网络层：*P2P* 网络、*TCP/IP* 网络

-------

### 1.3 密码学在区块链中的技术应用

- **数字签名 *Digital Signature***：
    - 数字签名的**安全保障（不可伪造性）**：
        - 对于安全签名方案，攻击者无法输出有效（消息，签名）对的伪造，即使它获得了其选择的许多其他消息的签名。
    - 不可伪造性意味着**完整性 *Authenticity/Integrity* （防篡改）** 和 **不可否认性 *Non-repudiation***（假设公钥已经被公开和分布）
- **哈希函数 *Hash***：
    - 哈希函数的**安全保障（抗碰撞性）**：
        - 不可能在有效时间内找到 $x, x' \in \{0, 1\}^*$ 满足 $x \neq x'$ 且 $H(x) = H(x')$
- 当用户向区块链（*P2P*）网络发布记录（交易、事件等）时，**需要对记录进行签名**，生成的签名可以公开验证。 **在共识协议安全确认记录之前，签名将用于授权和验证记录**。
- 一旦记录被安全确认，即由一系列区块确认，任何人都不能再删除或篡改它。 换句话说，区块的哈希链和共识协议将保证已确认记录的不可篡改。

--------

### 1.4 区块链系统的种类

- **公共 *Public***：没有任何访问限制，任何实体都可以自由加入或离开系统，发布交易并参与共识协议
- **财团 *Consortium***：只有被授权的实体可以加入系统，查看或发布交易，参与共识协议
- **私人 *Private***：由某些中心组织控制

--------



## 2. 比特币 *Bitcoin*

### 2.1 比特币的账本 *The Ledger of Bitcoin*

- 比特币的定义：数字货币，基于交易的，去中心化的分布式账本

- **基于账户的账本**：每个 *acount* 对应一个 *balance*

    - 每笔交易都会导致账户余额的一次更新

- **基于交易的账本**：比特币的实现方法

    - 系统的记录是交易，而不是账户和余额
    - **核心业务对象是 *Transaction-Output (TXO)*，每笔交易会消耗现有的 *TXO* 并生成新的 *TXO***
        - 每个 *TXO* 仅可被消耗一次，每笔交易仅能消费未被消耗的 *TXO*（*UTXO* 模型）
        - 交易的有效性由其本身和试图消耗的输出来检查

    <img src="./cut/截屏2021-06-15 下午3.56.58.png" alt="avatar" style="zoom:35%;" />

    <img src="./cut/截屏2021-06-15 下午4.02.05.png" alt="avatar" style="zoom:35%;" />

- **如何将币/TXO与其所有者绑定，以便只有币的所有者才能使用它？**

    - **比特币的数字签名**：

        - **公钥作为比特币拥有者身份的象征**，**每个比特币都分配给一个公钥**，**一个公钥可包含多个比特币**
            - **私钥是拥有和花费 *TXO* / 比特币的唯一方式**
        - 当用户想在公钥 *pk* 上花费一个比特币时，他**发出一个交易 *TX* 来消费这个比特币，并使用与 *pk* 对应的私钥对 *TX*（作为要签名的消息）进行签名，生成签名 $\sigma$**。
            - 签名 $\sigma$ 证明该交易是由该比特币的拥有者发起的，且可以用来验证该交易没有伪造或篡改，且不可否认
            - **每笔交易 *TX* 是一个 (公钥, 值) 对 $(pk, v)$**

        <img src="./cut/截屏2021-06-15 下午4.20.34.png" alt="avatar" style="zoom:40%;" />

    - **比特币的隐私 *Privacy in Bitcoin***：

        - 在上述交易过程中，**每个交易个体被公钥所替代，真实的身份被隐藏**
        - **每个用户都可以产生任意数目的公钥-私钥对，理想情况下每个公私钥对仅被使用一次**，且同一条交易中，若支付者的公钥仍含有一定余额，则新建一个新的公私钥对来表示存储该余额

        <img src="./cut/截屏2021-06-15 下午4.33.32.png" alt="avatar" style="zoom:35%;" />

        - 问题：若 *TXO* 的顺序固定，则很容易通过每笔交易的 *value* 来猜测出哪几个公钥属于同一个用户

            - 可能的改进方案：隐藏转移的源头、隐藏转移的目的地、隐藏转移的 *value*

        - **使用哈希作为地址**：

            - **每一条 *TXO* 是一个 *(address, value)* 对，地址来自于收款人（可能有俩）公钥的哈希值**。对于每条转移交易，**收款人不需要将公钥发送给付款人，只需要发送公钥对应的哈希值**

                - 当用户想要发起交易 *TX* 来花费 *(addr, v)* 的 *TXO*，只需要提供公钥 *pk* 和签名 $\sigma$ 来使 *addr = H(pk)*，$Verify(pk, tx, \sigma)=1$

                <img src="./cut/截屏2021-06-15 下午4.48.41.png" alt="avatar" style="zoom:35%;" />

                - 注意，该哈希函数的输入除了公钥之外，还可以是情况描述，甚至一段无意义的字符串

----------

### 2.2 比特币的交易

- 交易的合法性：
    - 交易的 *TXO* 之前未被使用
    - 交易中提供的公钥和签名合法
    - 交易的总输出小于输入，缺失的部分是交易费用
- 交易的脚本：
    - *TXO* 中的 *address* 不仅是公钥的哈希值，还可以是一个包含操作码和操作数的脚本源代码：*scriptPubKey*
    - *Input* 中的签名和公钥也可以被视为脚本源代码，仅包括操作数，即公钥和签名：*scriptSig*
    - *scriptPubKey* 和 *scriptSig* 被放在一起，检查公钥和签名的合法性
    - **比特币脚本语言 *Bitcoin Script Language***

------

### 2.3 比特币的块

- 交易的物理尺寸很小，但数目很多，因此需要使用块来组织，比特币使用**默克尔树 *Merkle Tree*** 来将交易组织成块
    - **默克尔树 *Merkle Tree***：使用**哈希指针 *Hash Pointers*** 构建的二叉树，允许简要的成员资格证明，允许快速检查集合中的数据是否被篡改
    - **哈希指针 *Hash Pointers***：*H(DATA)*，作为身份证明，可以查找 *DATA*
    - **哈希链 *Hash Chain***：**每个数据块由其哈希值来代表身份**。防篡改（拥有最后一个哈希值，可以检查数据链上的修改）
- **每个块被组织为默克尔树的形式，根节点的哈希值被存储在 *block header* 内，同样在里面的还有指向前一个 *block header* 的指针，*block headers* 被哈希指针串联起来，形成区块链**

- **挖矿 *Mining***：没有中心权威机构来生成块和创建比特币，相反，所有参与者都在竞争，获胜者将获得生成区块并将区块（即包含的交易）放入分类账（即区块链）的权利。每个区块中的 coinbase 交易都会创建新的硬币。 由于区块创建者可以在coinbase交易中指定区块奖励和交易费用的币地址，从而激励参与者竞争赢得创建区块的权利。
    - 有一个系统参数，称为难度，它指定如果一个区块的哈希值小于特定值，则该区块是有效的。如何找到这样的块？在块头中设置nonce的值，然后计算块头的哈希值。 如果小于目标，则找到有效的候选块，否则，更改随机数，然后重试。
    - 系统通过调整挖矿难度来控制出块速度
    - 请注意，没有签名来保证 coinbase 交易的完整性。 攻击者能否修改他人的 coinbase 交易以获得区块奖励和交易费用？**不可以，因为 *coinbase* 交易会被同步到所有参与者的本地拷贝中，攻击者对所有参与主机进行攻击的时间和资源花费太大**

------

### 2.4 比特币的区块链

- **比特币网络 *Bitcoin Network***：*P2P*、所有节点平等、在 *TCP* 网络中运行，随机拓扑、动态改变（由于节点的加入和离开）
    - 运行**洪流算法 *flooding algorithm***：合法数据快速传播，并及时停止传播
        - 每个节点都对接收到的运行一系列的检查，以确定数据是否合法
        - 若合法，则继续检查数据是否已经在节点的本地池中
        - 若不在，则将该数据加入本地池，并转发给其伙伴节点；否则不做操作
    - 当一个用户/节点发出一次交易，其将这次交易广播给所有的伙伴节点，接收到本次交易的节点执行洪流算法
    - 矿工节点从其交易池中选择一组交易，构建对应的coinbase交易，并构建这些交易的Merkle Tree，然后将当前本地区块链中的最新区块作为前一个区块，开始挖矿：结合previousblockhash计算hash 、merkle tre root 和不同的 nonce。 如有必要，更改 coinbase 交易中的 coinbase 参数。一些矿工找到一个有效的候选区块，然后将候选区块（包括 Merkle 树和区块头）广播到比特币网络。
    - 当一个节点接收到一个新的候选区块时，运行洪流算法（每个节点的策略有所不同
- **比特币协议的默认策略**：
    - 当一个节点收到多个冲突的交易时，它会保留第一个收到的交易，并丢弃其他交易。
    - 当接收到的新区块使本地区块链 *fork* 时，上述 *race condition* 会被解决
- **比特币共识 *Bitcoin Consensus***：
    - 完全验证节点 *fully validating nodes*
    - 轻量节点 *lightweight nodes*
    - 可以保证每个节点的本地区块链与全局区块链保持一致
    - **比特币共识协议**：所有诚实的节点必须对一个值必须统一，值必须由诚实的节点生成

--------

### 2.5 比特币挖矿工具

- 矿池：比特币矿工的相互保险。
    - *Pool Manager*：准备待挖的区块，并告知 (*pool members*)，做了除计算哈希之外的所有事
    - *Pool Member*：并行挖矿，尝试 *nonce*，计算哈希值，寻找合法的候选区块，仅计算哈希
    - 优点：使得挖矿更加可预测，适合小机器参与；更容易更新网络
    - 缺点：是中心化的一种形式；减少了验证节点的数目；使得某些攻击更容易（*block discarding attack*：没有什么可以强制成员矿工在找到它们时实际将有效块提交给矿池管理器）

---------

### 2.6 比特币的潜在攻击

- 交易二次使用攻击 *Double-spending by forking attacks*
- 自私挖矿攻击 *Selfish Mining*

------

### 2.7 电子钱包：比特币的密钥管理

- 如何存储和消费比特币？
    - 存储公钥和用来签名的私钥，使用私钥签名来消费比特币
- 在本机的文件中存储
    - 钱包 *Wallet*：用来存储和管理密钥的软件或硬件
    - 热存储（在线、使用更频繁）、冷存储（离线、地址仅使用一次，就需要转移比特币到新的冷地址）
- 确定性钱包：
    - 所有密钥对都可以从“种子”确定性生成的钱包
    - 主公钥属性：公钥可以从主公钥派生，不需要（主）密钥
    - 层次结构属性：每个（公钥、私钥）对都可以作为其子组织的主密钥。

- 在线钱包：
    - 在线钱包有点像您可以自己管理的本地钱包，但信息存储在云中，您可以使用计算机上的 Web 界面或智能手机上的应用程序访问它。
